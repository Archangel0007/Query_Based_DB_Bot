check my upload.html

{% extends "index.html" %}

{% block title %}Data Upload - Schema Builder{% endblock %}

{% block content %}
<div class="page-layout">
    <div class="sidebar-left">
        <h3>üñºÔ∏è Schema Preview</h3>
        <div id="schema-image-container" style="display: none;"></div>
    </div>
    <div class="main-content-right">
        <div id="status-bar">
            <div class="spinner" id="spinner"></div>
            <span id="status-text"></span>
        </div>

        <div class="form-container" id="form-container">
            <h3>Provide Data and Context</h3>
            <p><strong>Accepted Data Types:</strong> CSV, JSON, XLS, PDF/DOC, XML, Website/HTML, TXT</p>
            <form id="upload-form">
                <label for="data_medium">Select Data Source Medium:</label>
                <select id="data_medium" name="data_medium">
                    <option value="direct_file_drop">Direct File Drop</option>
                    <option value="sharepoint_link">SharePoint Link</option>
                    <option value="aws_dynamodb">AWS DynamoDB</option>
                    <option value="azure_cosmosdb">Azure Cosmos DB</option>
                    <option value="s3_bucket">S3 Bucket</option>
                    <option value="Website/HTML">Website/HTML</option>
                </select>

                <div id="direct_file_drop_input" class="medium-input-group">
                    <label for="csv_files">Upload File(s):</label>
                    <input type="file" id="csv_files" name="csv_files" multiple>
                </div>

                <div id="sharepoint_link_input" class="medium-input-group" style="display: none;">
                    <label for="sharepoint_link">SharePoint Link:</label>
                    <input type="text" id="sharepoint_link" name="sharepoint_link" placeholder="e.g., https://yourcompany.sharepoint.com/sites/data/file.xlsx">
                </div>

                <div id="website_input" class="medium-input-group" style="display: none;">
                    <label class="input-label" for="website_link">Website / HTML URL</label>
                    <input class="input-field" type="url" id="website_link" name="website_link" placeholder="https://example.com/">
                    <small class="muted">Provide a public URL to a page containing structured tables or data to extract.</small>
                </div>

                <div id="aws_dynamodb_input" class="medium-input-group" style="display: none;">
                    <div class="group-title">AWS DynamoDB (structured fields or connection string)</div>
                    <label class="input-label" for="dynamodb_table_name">Table name</label>
                    <input class="input-field" type="text" id="dynamodb_table_name" name="dynamodb_table_name" placeholder="e.g., orders">

                    <label class="input-label" for="dynamodb_region">Region</label>
                    <input class="input-field" type="text" id="dynamodb_region" name="dynamodb_region" placeholder="e.g., us-east-1">

                    <label class="input-label" for="dynamodb_access_key">AWS Access Key </label>
                    <input class="input-field" type="text" id="dynamodb_access_key" name="dynamodb_access_key" placeholder="Access key">

                    <label class="input-label" for="dynamodb_secret_key">AWS Secret Key </label>
                    <input class="input-field" type="password" id="dynamodb_secret_key" name="dynamodb_secret_key" placeholder="Secret key">

                    <!-- Connection string option removed: please fill structured fields above -->
                </div>

                <div id="azure_cosmosdb_input" class="medium-input-group" style="display: none;">
                    <div class="group-title">Azure Cosmos DB (structured fields or connection string)</div>
                    <label class="input-label" for="cosmos_uri">Cosmos URI</label>
                    <input class="input-field" type="text" id="cosmos_uri" name="cosmos_uri" placeholder="e.g., https://xxxx.documents.azure.com:443/">

                    <label class="input-label" for="cosmos_db">Database name</label>
                    <input class="input-field" type="text" id="cosmos_db" name="cosmos_db" placeholder="Database name">

                    <label class="input-label" for="cosmos_collection">Collection name</label>
                    <input class="input-field" type="text" id="cosmos_collection" name="cosmos_collection" placeholder="Collection name">

                    <!-- Connection string option removed: please fill structured fields above -->
                </div>

                <div id="s3_bucket_input" class="medium-input-group" style="display: none;">
                    <div class="group-title">S3 (structured fields or s3:// path)</div>
                    <label class="input-label" for="s3_bucket_name">Bucket name</label>
                    <input class="input-field" type="text" id="s3_bucket_name" name="s3_bucket_name" placeholder="e.g., my-bucket">

                    <label class="input-label" for="s3_object_key">Object key</label>
                    <input class="input-field" type="text" id="s3_object_key" name="s3_object_key" placeholder="e.g., path/to/file.csv">

                    <label class="input-label" for="s3_region">Region </label>
                    <input class="input-field" type="text" id="s3_region" name="s3_region" placeholder="e.g., us-east-1">

                    <label class="input-label" for="s3_access_key">S3 Access Key </label>
                    <input class="input-field" type="text" id="s3_access_key" name="s3_access_key" placeholder="Access key">

                    <label class="input-label" for="s3_secret_key">S3 Secret Key </label>
                    <input class="input-field" type="password" id="s3_secret_key" name="s3_secret_key" placeholder="Secret key">

                    <!-- Connection string/path option removed: please fill structured fields above -->
                </div>

                <label for="schema_context">Provide context about your schema (required):</label>
                <textarea id="schema_context" name="schema_context" rows="4" placeholder="e.g., A customer can have many orders. An order belongs to one customer." required></textarea>
                <button type="submit">Generate Dimensional Model</button>
            </form>

            <!-- Logs panel placed immediately after the Generate button as requested -->
            <div id="logs-wrapper" class="logs-wrapper" style="margin-top:12px;">
                <button id="logs-toggle-btn" class="btn">Show logs</button>
                <div id="logs-panel" style="display:none; margin-top:8px;">
                    <div id="logs-container" style="max-height:240px; overflow:auto; border:1px solid var(--border-color); padding:8px; background:var(--panel-bg-color); border-radius:4px;"></div>
                </div>
            </div>
        </div>

        <div class="review-container" id="review-container" style="display: none;">
            <h3>üîé Step 2: Review and Confirm Schema</h3>
            <p>Is this schema correct? Type 'yes' to confirm, or 'no' followed by your corrections.</p>
            <textarea id="review-feedback" rows="3"></textarea>
            <button id="submit-review-btn">Submit Feedback</button>
        </div>    
        <!-- Approval buttons container (populated dynamically) -->
        <div id="approval-container" style="display:none; margin-top:12px;"></div>
    
        <div id="chat-section" style="display: none;">
            <h2>üß† Schema Chat</h2>
            <div class="chat-container" id="chat-container">
                <!-- Chat messages will be injected here -->
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        const form = document.getElementById('upload-form');
        const chatContainer = document.getElementById('chat-container');
        const statusText = document.getElementById('status-text');
        const spinner = document.getElementById('spinner');
        const formContainer = document.getElementById('form-container');
        const reviewContainer = document.getElementById('review-container');
        const chatSection = document.getElementById('chat-section');
        const schemaImageContainer = document.getElementById('schema-image-container');
        const logsToggleBtn = document.getElementById('logs-toggle-btn');
        const logsContainer = document.getElementById('logs-container');
        const logsWrapper = document.getElementById('logs-wrapper');

        // Helper to insert an element after a reference node
        function insertAfter(newNode, referenceNode) {
            referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
        }

        // Move logs under the chat container when chat is visible; otherwise keep logs below the generate form
        function relocateLogs() {
            try {
                // If chatSection is visible (pipeline in motion), move logs below chat container
                if (chatSection && chatSection.style.display && chatSection.style.display !== 'none') {
                    // ensure logsWrapper sits right after the chat container
                    if (logsWrapper && chatContainer && chatContainer.parentNode) {
                        insertAfter(logsWrapper, chatContainer);
                    }
                } else {
                    // keep logs inside the form container, directly after the form
                    if (logsWrapper && form && form.parentNode) {
                        insertAfter(logsWrapper, form);
                    }
                }
            } catch (err) {
                console.error('relocateLogs error', err);
            }
        }
        const submitReviewBtn = document.getElementById('submit-review-btn');
    
    const dataMediumSelect = document.getElementById('data_medium');
    const directFileDropInput = document.getElementById('direct_file_drop_input');
    const sharepointLinkInput = document.getElementById('sharepoint_link_input');
    const websiteInput = document.getElementById('website_input');
    const awsDynamoDBInput = document.getElementById('aws_dynamodb_input');
    const azureCosmosDBInput = document.getElementById('azure_cosmosdb_input');
    const s3BucketInput = document.getElementById('s3_bucket_input');

        let taskId = null;
        let pollingInterval = null;

    function showSelectedMediumInput() {
        // Hide all input groups first
        directFileDropInput.style.display = 'none';
        sharepointLinkInput.style.display = 'none';
        websiteInput.style.display = 'none';
        awsDynamoDBInput.style.display = 'none';
        azureCosmosDBInput.style.display = 'none';
        s3BucketInput.style.display = 'none';

        // Show the selected one
        switch (dataMediumSelect.value) {
            case 'direct_file_drop':
                directFileDropInput.style.display = 'block';
                break;
            case 'sharepoint_link':
                sharepointLinkInput.style.display = 'block';
                break;
            case 'Website/HTML':
                websiteInput.style.display = 'block';
                break;
            case 'aws_dynamodb':
                awsDynamoDBInput.style.display = 'block';
                break;
            case 'azure_cosmosdb':
                azureCosmosDBInput.style.display = 'block';
                break;
            case 's3_bucket':
                s3BucketInput.style.display = 'block';
                break;
        }
    }

    // Initial call to set the correct visibility on page load
    showSelectedMediumInput();

    // Initialize logs panel: hide container and wire toggle button
    if (logsToggleBtn && logsContainer) {
        const logsPanel = document.getElementById('logs-panel');
        // start hidden
        logsPanel.style.display = 'none';
        logsContainer.style.display = 'block'; // container inside panel should be visible when panel is shown
        logsToggleBtn.textContent = 'Show logs';
        logsToggleBtn.addEventListener('click', () => {
            if (logsPanel.style.display === 'none') {
                logsPanel.style.display = 'block';
                logsToggleBtn.textContent = 'Hide logs';
            } else {
                logsPanel.style.display = 'none';
                logsToggleBtn.textContent = 'Show logs';
            }
        });
    }

    // Ensure logs start in the correct location on page load
    relocateLogs();

    // Add event listener for changes in the dropdown
    dataMediumSelect.addEventListener('change', showSelectedMediumInput);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
        const submitButton = form.querySelector('button');
        submitButton.disabled = true;
            statusText.textContent = 'Uploading files...';
            spinner.style.display = 'inline-block';

        const formData = new FormData();
        formData.append('schema_context', document.getElementById('schema_context').value);
        formData.append('data_medium', dataMediumSelect.value);

        let source_provided = false;

        // Append data based on selected medium
        switch (dataMediumSelect.value) {
            case 'direct_file_drop':
                const files = document.getElementById('csv_files').files;
                if (files.length > 0) {
                    for (let i = 0; i < files.length; i++) {
                        formData.append('csv_files', files[i]);
                    }
                    source_provided = true;
                }
                break;
            case 'sharepoint_link':
                const sharepointLink = document.getElementById('sharepoint_link').value;
                if (sharepointLink.trim()) {
                    formData.append('sharepoint_link', sharepointLink);
                    source_provided = true;
                }
                break;
            case 'aws_dynamodb':
                // Only structured fields supported now
                const dynamodbTable = document.getElementById('dynamodb_table_name').value;
                const dynamodbRegion = document.getElementById('dynamodb_region').value;
                const dynamodbAccessKey = document.getElementById('dynamodb_access_key').value;
                const dynamodbSecretKey = document.getElementById('dynamodb_secret_key').value;

                if (dynamodbTable.trim()) {
                    formData.append('dynamodb_table_name', dynamodbTable.trim());
                    if (dynamodbRegion.trim()) formData.append('dynamodb_region', dynamodbRegion.trim());
                    if (dynamodbAccessKey.trim()) formData.append('dynamodb_access_key', dynamodbAccessKey.trim());
                    if (dynamodbSecretKey.trim()) formData.append('dynamodb_secret_key', dynamodbSecretKey.trim());
                    source_provided = true;
                }
                break;
            case 'azure_cosmosdb':
                // Only structured fields supported now
                const cosmosUri = document.getElementById('cosmos_uri').value;
                const cosmosDb = document.getElementById('cosmos_db').value;
                const cosmosCollection = document.getElementById('cosmos_collection').value;

                if (cosmosUri.trim() && cosmosDb.trim() && cosmosCollection.trim()) {
                    formData.append('cosmos_uri', cosmosUri.trim());
                    formData.append('cosmos_db', cosmosDb.trim());
                    formData.append('cosmos_collection', cosmosCollection.trim());
                    source_provided = true;
                }
                break;
            case 'Website/HTML':
                // Website URL input
                const websiteLink = document.getElementById('website_link').value;
                if (websiteLink && websiteLink.trim()) {
                    formData.append('website_link', websiteLink.trim());
                    source_provided = true;
                }
                break;
            case 's3_bucket':
                // Only structured fields supported now
                const s3BucketName = document.getElementById('s3_bucket_name').value;
                const s3ObjectKey = document.getElementById('s3_object_key').value;
                const s3Region = document.getElementById('s3_region').value;
                const s3AccessKey = document.getElementById('s3_access_key').value;
                const s3SecretKey = document.getElementById('s3_secret_key').value;

                if (s3BucketName.trim() && s3ObjectKey.trim()) {
                    formData.append('s3_bucket_name', s3BucketName.trim());
                    formData.append('s3_object_key', s3ObjectKey.trim());
                    if (s3Region.trim()) formData.append('s3_region', s3Region.trim());
                    if (s3AccessKey.trim()) formData.append('s3_access_key', s3AccessKey.trim());
                    if (s3SecretKey.trim()) formData.append('s3_secret_key', s3SecretKey.trim());
                    source_provided = true;
                }
                break;
        }

        if (!source_provided || !document.getElementById('schema_context').value.trim()) {
            alert('Please provide a data source and the required schema context.');
            submitButton.disabled = false;
            spinner.style.display = 'none';
            return;
        }

            const response = await fetch('/start_generation', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                taskId = data.task_id;
                formContainer.style.display = 'none';
                chatSection.style.display = 'block'; // Show chat after upload
                // Move logs to sit beneath the chat container now that pipeline is running
                relocateLogs();
                pollingInterval = setInterval(pollStatus, 2000);
            } else {
            const errorData = await response.json();
            alert('Error starting generation: ' + (errorData.error || 'Unknown error'));
            submitButton.disabled = false;
                spinner.style.display = 'none';
                // Ensure logs remain with the form if generation failed
                relocateLogs();
            }
        });

        submitReviewBtn.addEventListener('click', async () => {
            const feedback = document.getElementById('review-feedback').value;
            submitReviewBtn.disabled = true;

            try {
                const res = await fetch(`/submit_review/${taskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback: feedback })
                });

                const data = await res.json();
                if (!res.ok) {
                    alert('Error submitting feedback: ' + (data.error || 'Unknown error'));
                    submitReviewBtn.disabled = false;
                    return;
                }

                // hide review box and immediately poll status to update UI
                reviewContainer.style.display = 'none';
                document.getElementById('review-feedback').value = '';
                pollStatus();
            } catch (err) {
                alert('Network error submitting feedback: ' + err.message);
                submitReviewBtn.disabled = false;
            }
        });

        function showImageModal(src) {
            // Remove existing modal if any
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }

            // Create modal elements
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';

            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';

            const modalImage = document.createElement('img');
            modalImage.src = src;

            const closeModalBtn = document.createElement('button');
            closeModalBtn.className = 'modal-close';
            closeModalBtn.innerHTML = '&times;'; // 'x' symbol

            // Assemble modal
            modalContent.appendChild(modalImage);
            modalContent.appendChild(closeModalBtn);
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            // Add event listeners to close the modal
            const closeModal = () => modalOverlay.remove();
            closeModalBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal(); // Close only if clicking on the background
            });
        }

        async function pollStatus() {
            if (!taskId) return;

            const response = await fetch(`/status/${taskId}`);
            const data = await response.json();

            // Update status text
            statusText.textContent = data.status;
            if (data.status === 'Completed' || data.status.startsWith('Error')) {
                spinner.style.display = 'none';
                clearInterval(pollingInterval);
            } else {
                spinner.style.display = 'inline-block';
            }

            // Update chat logs
            chatContainer.innerHTML = ''; // Clear previous logs
            data.logs.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-msg ${msg.role}`;
                msgDiv.innerHTML = `<b>${msg.role === 'user' ? 'You' : 'Assistant'}</b><br>${msg.text.replace(/\n/g, '<br>')}`;
                chatContainer.appendChild(msgDiv);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Update logs panel (system logs captured from server prints). Render fully expanded entries.
            if (logsContainer) {
                logsContainer.innerHTML = '';
                const logs = data.system_logs || [];
                if (logs.length === 0) {
                    const none = document.createElement('div');
                    none.className = 'muted';
                    none.textContent = 'No logs available yet.';
                    logsContainer.appendChild(none);
                } else {
                    logs.forEach(l => {
                        const entry = document.createElement('div');
                        entry.className = 'log-entry';
                        const hdr = document.createElement('div');
                        hdr.className = 'log-header';
                        const ts = document.createElement('span');
                        ts.className = 'log-ts';
                        ts.textContent = l.time ? new Date(l.time).toLocaleString() : '';
                        hdr.appendChild(ts);
                        const body = document.createElement('pre');
                        body.textContent = l.text || '';
                        body.style.whiteSpace = 'pre-wrap';
                        entry.appendChild(hdr);
                        entry.appendChild(body);
                        logsContainer.appendChild(entry);
                    });
                    // scroll to bottom so latest logs are visible
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                }
            }

            // Show schema image if available
            if (data.schema_image_url) {
                const imageUrl = `${data.schema_image_url}?t=${new Date().getTime()}`;
                let img = schemaImageContainer.querySelector('img');
                if (!img) {
                    schemaImageContainer.innerHTML = `<img src="${imageUrl}" alt="Generated Schema">`;
                    img = schemaImageContainer.querySelector('img');
                    img.addEventListener('click', () => showImageModal(imageUrl));
                } else {
                    // Update src to refresh the image if it changed
                    if (img.src !== imageUrl) img.src = imageUrl;
                }
                schemaImageContainer.style.display = 'block';
            }

            // Show review box if awaiting review
            if (data.status === 'Awaiting user review' && reviewContainer.style.display === 'none') {
                reviewContainer.style.display = 'block';
            }

                        // --- Approval UI (show Approve+Regenerate only when awaiting approval) ---
            
            // Approval area
const approvalContainer = document.getElementById('approval-container');
approvalContainer.innerHTML = '';
approvalContainer.style.display = 'none';
const awaiting = data.awaiting_approval || null;
if (awaiting) {
    approvalContainer.style.display = 'block';

    const viewBtn = document.createElement('button');
    viewBtn.className = 'btn';
    viewBtn.style.marginRight = '8px';
    viewBtn.textContent = 'üëÅÔ∏è View Script';
    viewBtn.onclick = () => {
        window.open(`/view_script/${taskId}/${awaiting}`, '_blank', 'noopener');
    };

    const approveBtn = document.createElement('button');
    approveBtn.className = 'btn';
    approveBtn.style.marginRight = '8px';
    approveBtn.textContent = awaiting === 'create' ? '‚úÖ Approve table creation' : '‚úÖ Approve table insertion';

    const regenBtn = document.createElement('button');
    regenBtn.className = 'btn';
    regenBtn.textContent = 'üîÅ Regenerate (no-op)';
    regenBtn.style.opacity = '0.85';

    approveBtn.onclick = async () => {
        approveBtn.disabled = true;
        approveBtn.textContent = 'Running...';
        try {
            const resp = await fetch(`/approve_action/${taskId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: awaiting })
            });
            const payload = await resp.json();
            if (!resp.ok) {
                alert('Approval failed: ' + (payload.error || payload.message || 'Unknown error'));
                approveBtn.disabled = false;
                approveBtn.textContent = awaiting === 'create' ? '‚úÖ Approve table creation' : '‚úÖ Approve table insertion';
            } else {
                // status will update on next poll and approval UI will disappear
            }
        } catch (err) {
            alert('Network error during approval: ' + err.message);
            approveBtn.disabled = false;
            approveBtn.textContent = awaiting === 'create' ? '‚úÖ Approve table creation' : '‚úÖ Approve table insertion';
        }
    };

    regenBtn.onclick = () => {
        const lc = document.getElementById('logs-container') || document.getElementById('chat-container');
        if (lc) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.textContent = `${new Date().toLocaleTimeString()} ‚Äî Regenerate requested (no-op)`;
            lc.appendChild(div);
            lc.scrollTop = lc.scrollHeight;
        }
    };

    approvalContainer.appendChild(viewBtn);
    approvalContainer.appendChild(approveBtn);
    approvalContainer.appendChild(regenBtn);
}
 

        }
    </script>
{% endblock %}
    
    <!-- Logs panel markup inserted outside scripts so elements exist for JS references -->
    {% block after_body %}{% endblock %}
<!--
[PROMPT_SUGGESTION]How can I deploy this Flask application to a cloud service like Heroku or Vercel?[/PROMPT_SUGGESTION]
[PROMPT_SUGGESTION]Modify the background task processing to use a more robust job queue like Celery with Redis.[/PROMPT_SUGGESTION]
